@model E_Learning.ModelsDMST.ThanhVienView
<script src="@Url.Content("~/Scripts/jquery.validate.min.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/jquery.validate.unobtrusive.min.js")" type="text/javascript"></script>

@using (Html.BeginForm("Create", "RenewTieuBanBoPhan", FormMethod.Post, new { id = "formCreate" }))
{
    @Html.AntiForgeryToken()
    <div class="modal-dialog" style="max-width:800px" id="formF">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="ModalTitle"></h5>
                <a href="#" class="close" data-dismiss="modal">&times;</a>
            </div>
            <div class="modal-body">

                @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                <fieldset id="SubmitForm">
                    <div class="row">
                        <div class="form-group col-md-6">
                            <label for="BoPhan">Chọn Bộ phận</label>
                            @Html.DropDownList("PhongBanID", (IEnumerable<SelectListItem>)ViewBag.DSPhongBan, "Chọn phòng ban", new { @class = "form-control", id = "ddlPhongBan" })
                        </div>
                    </div>

                    <div id="thanhVienContainer">
                        <div class="row mt-3 thanhVienRow">
                            <div class="form-group col-md-5">
                                <label>Chọn thành viên</label>
                                <select name="ThanhVienList[0].NhanVienID" class="form-control ddlNhanVien">
                                    <option value="">-- Chọn thành viên --</option>
                                </select>
                            </div>
                            <div class="form-group col-md-3">
                                <label>Chọn chức vụ</label>
                                <select name="ThanhVienList[0].ChucVuID" class="form-control ddlChucVu">
                                    @foreach (var item in (IEnumerable<SelectListItem>)ViewBag.DSChucVu)
                                    {
                                        <option value="@item.Value">@item.Text</option>
                                    }
                                </select>
                            </div>
                            <div class="form-group col-md-4">
                                <label>Email</label>
                                <input type="email" name="ThanhVienList[0].Email" class="form-control emailInput" placeholder="Nhập email" />
                            </div>
                            <div class="form-group col-md-2 d-flex align-items-end">
                                <button type="button" class="btn btn-danger btnRemoveThanhVien" style="display:none;">Xóa</button>
                            </div>
                        </div>
                    </div>


                    <div class="mt-2">
                        <button type="button" class="btn btn-outline-primary" id="btnAddThanhVien">
                            <i class="fas fa-plus"></i> Thêm thành viên
                        </button>
                    </div>

                    <div class="mt-3">
                        <button type="submit" class="btn btn-success" id="btnXacNhan">Xác nhận</button>
                        <input type="reset" value="Hủy" class="btn btn-danger button_cancel" data-dismiss="modal" />
                    </div>
                </fieldset>
            </div>
        </div>
    </div>
}
<script>
    var thanhVienIndex = 1;

    $('#ddlPhongBan').change(function () {
        var idPB = $(this).val();
        $('.ddlNhanVien').html('<option value="">-- Chọn nhân viên --</option>');

        if (idPB) {
            $.getJSON('@Url.Action("GetNhanViensByPhongBan")', { idPB: idPB }, function (data) {
                $('.ddlNhanVien').each(function () {
                    var $dropdown = $(this);
                    $dropdown.empty().append('<option value="">-- Chọn nhân viên --</option>');
                    $.each(data, function (i, nv) {
                        $dropdown.append($('<option>').val(nv.Value).text(nv.Text));
                    });
                });
            });
        }
    });

    $('#btnAddThanhVien').click(function () {
        var idPB = $('#ddlPhongBan').val();
        if (!idPB) {
            alert("Vui lòng chọn phòng ban trước.");
            return;
        }

        $.getJSON('@Url.Action("GetNhanViensByPhongBan")', { idPB: idPB }, function (data) {
            var html = `
            <div class="row mt-3 thanhVienRow">
                <div class="form-group col-md-5">
                    <label>Chọn thành viên</label>
                    <select name="ThanhVienList[${thanhVienIndex}].NhanVienID" class="form-control ddlNhanVien">
                        <option value="">-- Chọn nhân viên --</option>`;
            $.each(data, function (i, nv) {
                html += `<option value="${nv.Value}">${nv.Text}</option>`;
            });
            html += `</select>
                </div>

                <div class="form-group col-md-3">
                    <label>Chọn chức vụ</label>
                    <select name="ThanhVienList[${thanhVienIndex}].ChucVuID" class="form-control ddlChucVu">
                        @foreach (var item in (IEnumerable<SelectListItem>)ViewBag.DSChucVu)
                        {
                            <option value="@item.Value">@item.Text</option>
                        }
                    </select>
                </div>

                <div class="form-group col-md-4">
                    <label>Email</label>
                    <input type="email" name="ThanhVienList[${thanhVienIndex}].Email" class="form-control emailInput" placeholder="Nhập email" />
                </div>

                <div class="form-group col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-danger btnRemoveThanhVien">Xóa</button>
                </div>
            </div>`;

            $('#thanhVienContainer').append(html);
            thanhVienIndex++;
        });
    });

    function updateThanhVienIndex() {
        thanhVienIndex = 0;
        $('#thanhVienContainer .thanhVienRow').each(function () {
            $(this).find('.ddlNhanVien').attr('name', `ThanhVienList[${thanhVienIndex}].NhanVienID`);
            $(this).find('.ddlChucVu').attr('name', `ThanhVienList[${thanhVienIndex}].ChucVuID`);
            $(this).find('.emailInput').attr('name', `ThanhVienList[${thanhVienIndex}].Email`);
            thanhVienIndex++;
        });
    }

    $(document).on('click', '.btnRemoveThanhVien', function () {
        $(this).closest('.thanhVienRow').remove();
        updateThanhVienIndex();
    });

</script>
